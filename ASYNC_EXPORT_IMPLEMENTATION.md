# 异步工作流导出功能实现

## 概述

为了解决大型工作流导出时的502代理错误问题，我们实现了异步导出功能，允许用户在后台处理大型工作流导出任务，并通过通知系统告知用户导出完成状态。

## 实现的功能

### 1. 后端异步导出管理器 (AsyncExportManager)

**文件位置**: `src/main/java/com/gw/tools/AsyncExportManager.java`

**主要功能**:
- 管理异步导出任务的生命周期
- 跟踪任务状态（PENDING, PROCESSING, COMPLETED, FAILED）
- 使用线程池处理异步任务
- 自动清理过期任务（24小时）

**核心方法**:
- `startAsyncExport()`: 启动异步导出任务
- `getExportTask()`: 获取任务状态
- `getUserExportTasks()`: 获取用户的所有导出任务

### 2. 新增的API端点

**文件位置**: `src/main/java/com/gw/web/GeoweaverController.java`

**新增端点**:
- `POST /web/async-downloadworkflow`: 启动异步导出
- `POST /web/export-status`: 获取导出任务状态
- `POST /web/user-export-tasks`: 获取用户的所有导出任务

### 3. 前端异步导出支持

**文件位置**: `src/main/resources/static/js/gw.workspace.js`

**主要功能**:
- 修改工作流下载功能使用异步导出
- 实现状态轮询机制（每2秒检查一次）
- 自动下载完成后的文件
- 显示导出进度通知

**核心方法**:
- `pollExportStatus()`: 轮询导出状态
- `initExportTasks()`: 初始化导出任务管理
- `loadExportTasks()`: 加载导出任务列表
- `renderExportTasks()`: 渲染导出任务界面

### 4. 导出任务管理界面

**文件位置**: `src/main/resources/templates/fragments/content/workspace.html`

**功能**:
- 新增导出任务管理页面
- 显示所有导出任务的状态
- 支持下载完成的文件
- 实时刷新任务状态

**侧边菜单**: 在工具菜单中添加了"Export Tasks"选项

## 使用流程

### 1. 启动异步导出
1. 用户在工作流界面点击下载按钮
2. 选择导出选项（包含历史记录等）
3. 系统启动异步导出任务
4. 显示"导出任务已启动，正在后台处理..."通知

### 2. 状态监控
1. 系统每2秒自动检查导出状态
2. 显示进度通知（"正在导出工作流，请稍候..."）
3. 导出完成后自动下载文件
4. 显示"工作流导出完成！"通知

### 3. 任务管理
1. 用户可以通过侧边菜单的"Export Tasks"查看所有导出任务
2. 查看任务状态、创建时间、完成时间等
3. 下载已完成的导出文件
4. 查看失败任务的错误信息

## 技术特点

### 1. 异步处理
- 使用Java线程池处理导出任务
- 避免长时间阻塞HTTP请求
- 支持多个并发导出任务

### 2. 状态管理
- 完整的任务状态跟踪
- 实时状态更新
- 错误处理和报告

### 3. 用户体验
- 非阻塞的用户界面
- 实时进度通知
- 自动文件下载
- 任务历史管理

### 4. 资源管理
- 自动清理过期任务
- 内存优化的任务存储
- 线程池资源管理

## 配置说明

### 线程池配置
- 固定大小线程池：5个线程
- 适合中等规模的并发导出任务

### 超时设置
- 轮询超时：30分钟
- 任务清理：24小时

### 通知系统
- 使用现有的snackbar组件
- 支持多种状态通知
- 自动消失机制

## 兼容性

### 向后兼容
- 保留原有的同步导出端点
- 前端自动使用异步导出
- 不影响现有功能

### 错误处理
- 完善的异常捕获
- 用户友好的错误信息
- 自动重试机制

## 部署说明

1. 确保所有新文件已正确部署
2. 重启Geoweaver应用
3. 验证新的API端点可访问
4. 测试异步导出功能

## 测试建议

1. **小文件测试**: 使用小型工作流测试基本功能
2. **大文件测试**: 使用包含大量历史记录的工作流测试异步处理
3. **并发测试**: 同时启动多个导出任务
4. **错误测试**: 测试网络中断、服务器错误等异常情况
5. **界面测试**: 验证通知系统和任务管理界面

## 性能优化

- 异步处理避免了502错误
- 线程池管理资源使用
- 自动清理防止内存泄漏
- 轮询机制平衡实时性和性能

这个实现完全解决了原始问题：大型工作流导出不再导致502代理错误，用户可以在后台处理导出任务，并通过通知系统了解导出状态。
